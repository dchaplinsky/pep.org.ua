{% extends "base.jinja" %}
{% from "macros/_connections.jinja" import render_connection %}

{% set last_workplace = person.translated_last_workplace %}

{% block page_title %}{{ person.last_name }} {{ person.first_name }} {{ person.patronymic }}{% if last_workplace %}, {{ last_workplace[0] }}, {{ last_workplace[1] }}{% endif %}{% endblock %}

{% block extra_menu %}
    {% if request.user.is_superuser %}
        <li class="edit-page">
            <a href="{{ url('admin:core_person_change', person.id) }}" target="_blank"><i class="fa fa-pencil-square-o"></i></a>
        </li>
    {% endif %}
{% endblock %}

{% macro render_related_person(person, type) %}
    <li itemprop="{% if type == "family" %}relatedTo{% else %}knows{% endif %}" itemscope itemtype="http://schema.org/Person">
        <a href="{{ person.get_absolute_url() }}" itemprop="url">
            <span class="{% if person.is_pep %}is_pep {% endif %}name-pill" itemprop="name">
                <span itemprop="familyName">{{ person.last_name }}</span> <span itemprop="givenName">{{ person.first_name }}</span> <span itemprop="additionalName">{{ person.patronymic }}</span>
            </span>
        </a> &ndash;
        {% if person.rtype %}{{ _(person.rtype) }},{% endif %}
        {% if person.dob %}<meta itemprop="birthDate" content="{{ person.dob }} "/>{% endif %}

        {% set last_workplace = person.translated_last_workplace %}
        {% if last_workplace %}
        <span itemscope itemtype="http://schema.org/Organization" itemprop="worksFor"><span itemprop="name">{{ last_workplace[0] }}</span></span>,
        <span itemprop="jobTitle">{{ last_workplace[1] }}</span>
        {% endif %}
        

        {% if person.connection.has_additional_info %}
            <a href="#" class="modalConnectionShow" data-toggle="modal" data-target="#modalPerson-{{ person.pk }}">
               <i class="fa fa-info-circle info-gray"></i>
            </a>
        {% endif %}
        {{ render_connection(person.connection, "modalPerson-{}".format(person.pk)) }}
    </li>
{% endmacro %}


{% block content %}
{% set related_persons = person.all_related_persons %}
{% set assets, related_companies = person.related_companies %}
{% set workplaces = person.workplaces %}
<div class="container" itemscope itemtype="http://schema.org/Person">
    <div class="row">
        <div id="breadcrumbs">
            <ol class="breadcrumb">
                <li><a href="{{ url("wagtail_serve", "") }}">{{ _("Головна") }}</a></li>
                <li class="active">{{ _("Публічні діячі") }}</li>
                <li class="active">{{ person.last_name }} {{ person.first_name }} {{ person.patronymic }}</li>
            </ol>
        </div>
        <aside id="profile-nav" role="complementary" class="col-sm-2 hidden-xs">
            <ul id="side-profilemenu">
                <li><a href="#personal" class="btn btn-transp trans"><i class="fa fa-male"></i><span>{{ _("Персональні дані") }}</span></a></li>
                {% if LANGUAGE_CODE =="en" %}
                    {% if person.wiki_en %}
                        <li><a href="#profile" class="btn btn-transp trans"><i class="fa fa-briefcase"></i><span>{{ _("Досьє") }}</span></a></li>
                    {% endif %}
                {% else %}
                    {% if person.wiki %}
                        <li><a href="#profile" class="btn btn-transp trans"><i class="fa fa-briefcase"></i><span>{{ _("Досьє") }}</span></a></li>
                    {% endif %}
                {% endif %}

                {% if LANGUAGE_CODE =="en" %}
                    {% if person.reputation_sanctions_en or person.reputation_crimes_en or person.reputation_manhunt_en or person.reputation_convictions_en %}
                    <li><a href="#reputation" class="btn btn-transp trans"><i class="fa fa-bullhorn"></i><span>{{ _("Репутація") }}</span></a></li>
                    {% endif %}
                {% else %}
                    {% if person.reputation_sanctions_uk or person.reputation_crimes_uk or person.reputation_manhunt_uk or person.reputation_convictions_uk %}
                    <li><a href="#reputation" class="btn btn-transp trans"><i class="fa fa-bullhorn"></i><span>{{ _("Репутація") }}</span></a></li>
                    {% endif %}
                {% endif %}
                {% if workplaces %}
                <li><a href="#workbefore" class="btn btn-transp trans"><i class="fa fa-wrench"></i><span>{{ _("Кар'єра") }}</span></a></li>
                {% endif %}
                {% if declarations %}
                    <li><a href="#declarations" class="btn btn-transp trans"><i class="fa fa-file-text-o"></i><span>{{ _("Декларації") }}</span></a></li>
                {% endif %}
                {% if related_persons.all %}
                <li><a href="#connections" class="btn btn-transp trans"><i class="fa fa-heart"></i><span>{{ _("З'вязки") }}</span></a></li>
                {% endif %}
                {% if LANGUAGE_CODE =="en" %}
                    {% if assets or person.reputation_assets_en %}
                        <li><a href="#assets" class="btn btn-transp trans"><i class="fa fa-cubes"></i><span>{{ _("Статки") }}</span></a></li>
                    {% endif %}
                {% else %}
                    {% if assets or person.reputation_assets %}
                        <li><a href="#assets" class="btn btn-transp trans"><i class="fa fa-cubes"></i><span>{{ _("Статки") }}</span></a></li>
                    {% endif %}
                {% endif %}
                {% if related_companies %}
                    <li><a href="#related-companies" class="btn btn-transp trans"><i class="fa fa-building-o"></i><span>{{ _("Пов'язані юридичні особи") }}</span></a></li>
                {% endif %}
            </ul>
        </aside>
        <section id="profile" class="{%- if person.parsed_names %}col-sm-8{% else %}col-sm-10{% endif -%}">
            <link itemprop="url" href="{{ person.get_absolute_url() }}" />
            <div id="profile-wrap" class="box">
                <ul class="profileActions">
                    <li><a href="?format=pdf" class="tooltip-anchor" data-toggle="tooltip" data-placement="top" title="{{ _("Скачати PDF") }}" target="_blank"><i class="fa fa-file-pdf-o"></i></a></li>
                    <li><a href="#" class="tooltip-anchor print-me" data-toggle="tooltip" data-placement="top" title="{{ _("Роздрукувати профайл") }}"><i class="fa fa-print"></i></a></li>
                </ul>
                <header class="profile-header">
                    {% if person.photo %}
                    <div class="avatar">
                    <img src="{{ person.photo|thumbnail_url("avatar") }}" itemprop="image" alt="{{ person.last_name }} {{ person.first_name }} {{ person.patronymic }}"/>
                    </div>
                    {% endif %}
                    <h1 class="pep-name" itemprop="name"><span itemprop="familyName">{{ person.last_name }}</span> <span class="pep-pib"><span itemprop="givenName">{{ person.first_name }}</span> <span itemprop="additionalName">{{ person.patronymic }}</span></h1>
                </header>
                <div id="personal" class="sub">
                    <div class="table-responsive">
                        <table class="table table-condensed">
                            {% if person.type_of_official %}
                            <tr>
                                <td>{{ _("Категорія ПЕП") }} </td>
                                <td><strong>{{ _(person.get_type_of_official_display()) }}</strong></td>
                            </tr>
                            {% endif %}
                            {% if person.dob %}
                            <tr>
                                <td>{{ _("Дата народження") }}</td>
                                <td>
                                    <meta itemprop="birthDate" content="{{ person.dob }} "/>
                                    {{ person.date_of_birth }}
                                </td>
                            </tr>
                            {% endif %}
                            {% if person.city_of_birth %}
                            <tr>
                                <td>{{ _("Місце народження") }}</td>
                                <td itemprop="birthPlace">{{ person.city_of_birth }}</td>
                            </tr>
                            {% endif %}
                            {% if last_workplace %}
                            <tr>
                                <td>{{ _("Остання посада") }}</td>
                                <td>
                                    <strong>
                                        <span itemprop="worksFor" itemscope itemtype="http://schema.org/Organization"><span itemprop="name">{{ last_workplace[0] }}</span></span>, 
                                        <span itemprop="jobTitle">{{ last_workplace[1] }}</span>
                                    </strong>
                                </td>
                            </tr>
                            {% endif %}
                            {#<tr class="tooltip-anchor" data-toggle="tooltip" data-placement="bottom" title="{{ _("Відповідно до методології, національним публічним діячам присвоюється такі ступені ризику відмивання коштів: неприйнятно високий; високий; середній; низький") }}">
                                <td>{{ _("Рівень ризику") }}</td>
                                <td><strong>{{ _(person.get_risk_category_display()) }}</strong></td>
                            </tr>#}
                        </table>
                    </div>
                </div>
            </div>


            {% if LANGUAGE_CODE =="en" %}
                {% if person.wiki_en %}
                <div id="profile-wiki" class="sub box" itemprop="description">
                    <h3>{{ _("Досьє:") }}</h3>
                    <div class="printWrap">
                        {{ person.wiki_en|markdown }}
                    </div>
                </div>
                {% endif %}
            {% else %}
                {% if person.wiki_uk %}
                <div id="profile-wiki" class="sub box" itemprop="description">
                    <h3>{{ _("Досьє:") }}</h3>
                    <div class="printWrap">
                        {{ person.wiki_uk|markdown }}
                    </div>
                </div>
                {% endif %}
            {% endif %}

            {% if LANGUAGE_CODE =="en" %}
                {% if person.reputation_sanctions_en or person.reputation_crimes_en or person.reputation_manhunt_en or person.reputation_convictions_en %}
                <div id="reputation" class="sub box">
                    <h3>{{ _("Репутація:") }}</h3>
                    <div class="printWrap">
                        {% if person.reputation_sanctions_en %}
                            <h4>{{ _("Санкції") }}</h4>
                            {{ person.reputation_sanctions_en|markdown }}
                        {% endif %}
                        {% if person.reputation_crimes_en %}
                            <h4>{{ _("Кримінальні впровадження") }}</h4>
                            {{ person.reputation_crimes_en|markdown }}
                        {% endif %}
                        {% if person.reputation_manhunt_en %}
                            <h4>{{ _("Перебування у розшуку") }}</h4>
                            {{ person.reputation_manhunt_en|markdown }}
                        {% endif %}
                        {% if person.reputation_convictions_en %}
                            <h4>{{ _("Наявність судимості") }}</h4>
                            {{ person.reputation_convictions_en|markdown }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                {% if person.reputation_sanctions_uk or person.reputation_crimes_uk or person.reputation_manhunt_uk or person.reputation_convictions_uk %}
                <div id="reputation" class="sub box">
                    <h3>{{ _("Репутація:") }}</h3>
                    <div class="printWrap">
                        {% if person.reputation_sanctions_uk %}
                            <h4>{{ _("Санкції") }}</h4>
                            {{ person.reputation_sanctions_uk|markdown }}
                        {% endif %}
                        {% if person.reputation_crimes_uk %}
                            <h4>{{ _("Кримінальні впровадження") }}</h4>
                            {{ person.reputation_crimes_uk|markdown }}
                        {% endif %}
                        {% if person.reputation_manhunt_uk %}
                            <h4>{{ _("Перебування у розшуку") }}</h4>
                            {{ person.reputation_manhunt_uk|markdown }}
                        {% endif %}
                        {% if person.reputation_convictions_uk %}
                            <h4>{{ _("Наявність судимості") }}</h4>
                            {{ person.reputation_convictions_uk|markdown }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endif %}

            {% if workplaces %}
            <div id="workbefore" class="sub box">
                <h3>{{ _("Кар'єра:") }}</h3>
                <div class="printWrap">
                    <div id="element">
                        <ul class="timeline">
                            {% for connection in person.workplaces %}
                            <li class="tl-item">
                                <div class="tl-wrap">
                                    <span class="tl-date">
                                        {% if connection.date_established %}
                                            {{ connection.date_established_human }}
                                            <br/>
                                        {% endif %}
                                        {% if connection.date_finished %}
                                            {{ _("до") }}
                                            {{ connection.date_finished_human }}
                                        {% endif %}
                                    </span>
                                    <div class="tl-content panel padder b-a">
                                        <span class="arrow left pull-up"></span>
                                        <div>
                                            <span itemscope itemtype="http://schema.org/Organization" itemprop="worksFor"><span itemprop="name">{{ connection.to_company }}</span></span>, {{ connection.relationship_type }}
                                            {% if connection.has_additional_info %}
                                                <a href="#" class="modalConnectionShow" data-toggle="modal" data-target="#modalWork-{{ loop.index }}">
                                                   <i class="fa fa-info-circle info-gray"></i>
                                                </a>
                                            {% endif %}
                                        </div>   
                                    </div>
                                </div>
                                {{ render_connection(connection, "modalWork-{}".format(loop.index)) }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if declarations %}
            <div id="declarations" class="sub box">
                <h3>{{ _("Дані з декларації про доходи:") }}</h3>
                <div class="printWrap">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th class="decl-year">{{ _("Рік") }}</th>
                                    <th class="decl-position">{{ _("Посада") }}</th>
                                    <th class="decl-income">{{ _("Доходи декларанта") }}</th>
                                    <th class="decl-familyincome">{{ _("Доходи сім'ї") }}</th>
                                    <th class="decl-download"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for declaration in declarations %}
                                    <tr>
                                        <td class="decl-year">{{ declaration.source.intro.declaration_year }}</td>
                                        <td class="decl-position"><span itemscope="" itemtype="http://schema.org/Organization" itemprop="worksFor"><span itemprop="name">{{ declaration.office }}</span></span>, {{ declaration.position }}</td>
                                        <td class="decl-income">UAH {{ declaration.source.income['5'].value|curformat() }}</td>
                                        <td class="decl-familyincome">UAH {{ declaration.source.income['5'].family|curformat() }}</td>
                                        <td class="decl-download print-hidden"><a href="{{ declaration.url }}" title="{{ _("Відкрити декларацію") }}" target="_blank"><i class="fa fa-file-text-o"></i></a></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if related_persons.all %}
            <div id="connections" class="sub box">
                <h3>{{ _("Зв'язки:") }}</h3>
                <div class="printWrap">
                    <div class="tree">
                        <ul>
                            <li>
                                <span><i class="fa"></i> {{ person.last_name }} {{ person.first_name }} {{ person.patronymic }}</span>
                                <ul>
                                    {% if related_persons.family %}
                                    <li>
                                        <span class="badge badge-success"><i class="faicon fa fa-plus-square"></i> {{ _("Родина та близькі особи") }}</span>
                                        <ul class="h">
                                            {% for rp in related_persons.family %}
                                                {{ render_related_person(rp, "family") }}
                                            {% endfor %}
                                        </ul>
                                    </li>
                                    {% endif %}
                                    {% if related_persons.personal %}
                                    <li>
                                        <span class="badge badge-success"><i class="faicon fa fa-plus-square"></i> {{ _("Персональні зв'язки") }}</span>
                                        <ul class="h">
                                            {% for rp in related_persons.personal %}
                                                {{ render_related_person(rp, "personal") }}
                                            {% endfor %}
                                        </ul>
                                    </li>
                                    {% endif %}
                                    {% if related_persons.business %}
                                    <li>
                                        <span class="badge badge-success"><i class="faicon fa fa-plus-square"></i> {{ _("Ділові зв'язки") }}</span>
                                        <ul class="h">
                                            {% for rp in related_persons.business %}
                                                {{ render_related_person(rp, "business") }}
                                            {% endfor %}
                                        </ul>
                                    </li>
                                    {% endif %}
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if LANGUAGE_CODE =="en" %}
                {% if assets or person.reputation_assets_en %}
                    <div id="assets" class="sub box">
                        <h3>{{ _("Статки:") }}</h3>
                        <div class="printWrap">
                            {% for asset in assets %}
                                <div class="panel panel-default">
                                    <div class="panel-body" itemscope itemtype="http://schema.org/Organization" itemprop="affiliation">
                                        <span itemprop="name">{{ asset.to_company }}</span>
                                        {% if asset.to_company.edrpou %}
                                        , {{ _("ЄДРПОУ") }} <span itemprop="taxID">{{ asset.to_company.edrpou }}</span>
                                        {% endif%}
                                    </div>
                                    <div class="panel-footer">
                                        {{ asset.relationship_type }}
            
                                        {% if asset.has_additional_info %}
                                        <a href="#" class="modalConnectionShow" data-toggle="modal" data-target="#modalAsset-{{ loop.index }}">
                                            <i class="fa fa-info-circle info-gray"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>                
                                
                                {{ render_connection(asset, "modalAsset-{}".format(loop.index)) }}
                            {% endfor %}
                            {% if person.reputation_assets %}
                                {{ person.reputation_assets|markdown }}
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% else %}
                {% if assets or person.reputation_assets_uk %}
                    <div id="assets" class="sub box">
                        <h3>{{ _("Статки:") }}</h3>
                        <div class="printWrap">
                            {% for asset in assets %}
                                <div class="panel panel-default">
                                    <div class="panel-body" itemscope itemtype="http://schema.org/Organization" itemprop="affiliation">
                                        <a href="{{ asset.to_company.get_absolute_url() }}"><span itemprop="name">{{ asset.to_company }}</span></a>
                                        {% if asset.to_company.edrpou %}
                                        , {{ _("ЄДРПОУ") }} <span itemprop="taxID">{{ asset.to_company.edrpou }}</span>
                                        {% endif%}
                                    </div>
                                    <div class="panel-footer">
                                        {{ asset.relationship_type }}
            
                                        {% if asset.has_additional_info %}
                                        <a href="#" class="modalConnectionShow" data-toggle="modal" data-target="#modalAsset-{{ loop.index }}">
                                            <i class="fa fa-info-circle info-gray"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>                
                                
                                {{ render_connection(asset, "modalAsset-{}".format(loop.index)) }}
                            {% endfor %}
                            {% if person.reputation_assets_uk %}
                                {{ person.reputation_assets_uk|markdown }}
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            {% if related_companies %}
                <div id="related-companies" class="sub box">
                    <h3>{{ _("Пов'язані юридичні особи:") }}</h3>
                    <div class="printWrap">
                        {% for related_company in related_companies %}
                            <div class="panel panel-default">
                                <div class="panel-body" itemscope itemtype="http://schema.org/Organization" itemprop="affiliation">
                                    <a href="{{ related_company.to_company.get_absolute_url() }}"><span itemprop="name">{{ related_company.to_company }}</span></a>
                                    {% if related_company.to_company.edrpou %}
                                    , {{ _("ЄДРПОУ") }} <span itemprop="taxID">{{ related_company.to_company.edrpou }}</span>
                                    {% endif%}
                                </div>
                                <div class="panel-footer">
                                    {{ related_company.relationship_type }}

                                    {% if related_company.has_additional_info %}
                                    <a href="#" class="modalConnectionShow" data-toggle="modal" data-target="#modalRelatedCompany-{{ loop.index }}">
                                        <i class="fa fa-info-circle info-gray"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>

                            {{ render_connection(related_company, "modalRelatedCompany-{}".format(loop.index)) }}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </section>
        {% if person.parsed_names %}
        <aside id="profile-suggest" role="complementary" class="col-lg-2">
            <h3>{{ _("Можливо ви шукали:") }}</h3>
            <div class="printWrap">
                <ul>
                    {% for name_alt in person.parsed_names %}
                    <li itemprop="alternateName">{{ name_alt }}</li>
                    {% endfor %}
                </ul>
            </div>
        </aside>
        {% endif %}
    </div>
</div>
{% endblock %}